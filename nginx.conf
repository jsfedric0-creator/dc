worker_processes auto;
events {
    worker_connections 4096;
    use epoll;
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        buflen 3s;
        max_streams 128;
        
        # Main restream application
        application restream {
            live on;
            record off;
            meta copy;
            
            # Allow all connections (you can restrict in production)
            allow play all;
            allow publish all;
            
            # HLS output
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3;
            hls_playlist_length 60;
            hls_nested on;
            
            # DASH output
            dash on;
            dash_path /tmp/dash;
            dash_fragment 3;
            dash_playlist_length 60;
            
            # On publish handler
            on_publish http://localhost:5000/api/stream/auth;
            on_publish_done http://localhost:5000/api/stream/end;
            
            # Pull configuration
            pull_reconnect 3s;
        }
        
        # Proxy streams from source
        application proxy {
            live on;
            record off;
            
            # Example: Pull from source
            # pull rtmp://source.com:1935/live/stream_name;
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=m3u:10m rate=5r/s;
    
    # Cache settings
    proxy_cache_path /tmp/nginx levels=1:2 keys_zone=stream_cache:10m max_size=1g inactive=60m;
    
    # Dashboard server
    server {
        listen 80;
        server_name _;
        root /app/dashboard/static;
        
        # Dashboard
        location / {
            proxy_pass http://localhost:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # API endpoints
        location /api/ {
            limit_req zone=api burst=20;
            proxy_pass http://localhost:5000/api/;
            proxy_set_header Host $host;
            proxy_buffering off;
        }
        
        # M3U endpoint
        location /get.php {
            limit_req zone=m3u burst=10;
            
            if ($args ~* "username=(.*)&password=(.*)") {
                set $user $1;
                set $pass $2;
            }
            
            # Pass to Python handler
            proxy_pass http://localhost:5000/api/m3u?$args;
            proxy_set_header Host $host;
            
            # Cache M3U files for 5 minutes
            proxy_cache stream_cache;
            proxy_cache_valid 200 5m;
            add_header X-Cache-Status $upstream_cache_status;
        }
        
        # Xtream Codes API emulation
        location ~ ^/player_api\.php$ {
            proxy_pass http://localhost:5000/api/xtream;
            proxy_set_header Host $host;
        }
        
        # HLS streams
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Headers *;
            
            # Security headers
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
        }
        
        # DASH streams
        location /dash {
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }
        
        # TS stream proxy
        location ~ ^/live/(.*)/(.*)/(.*)$ {
            # Proxy to original source with authentication
            set $username $1;
            set $password $2;
            set $stream_id $3;
            
            # Validate credentials
            auth_request /api/validate;
            auth_request_set $auth_status $upstream_status;
            
            # If valid, proxy the stream
            if ($auth_status = 200) {
                proxy_pass http://backend-server/$stream_id;
                proxy_set_header Host backend-server;
                proxy_buffering off;
                proxy_read_timeout 86400s;
            }
            
            # If invalid, deny access
            if ($auth_status != 200) {
                return 403;
            }
        }
        
        # EPG endpoint
        location /xmltv.php {
            proxy_pass http://localhost:5000/api/epg;
            proxy_set_header Host $host;
        }
        
        # Static files
        location /static/ {
            alias /app/dashboard/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # HTTPS server (optional for Koyeb)
    server {
        listen 443 ssl;
        server_name _;
        
        ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
        ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
        
        # Same configuration as port 80
        # ... [copy from above]
    }
}
